name: Analyze Version Change

on:
  workflow_dispatch:
  repository_dispatch:
    types: [analyze-connector-changes]

jobs:
  analyze:
    name: Analyze connector version changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate git diff
        id: diff
        run: |
          # Get diff between master and auto-generate-connector branches
          # Only include client.bal and types.bal files
          git diff origin/master...origin/auto-generate-connector -- ballerina/client.bal ballerina/types.bal > git_diff.txt
          
          # Check if diff is not empty
          if [ ! -s git_diff.txt ]; then
            echo "No changes detected in client.bal or types.bal"
            exit 1
          fi
          
          echo "Diff generated successfully"
          echo "Diff size: $(wc -c < git_diff.txt) bytes"
      
      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: latest
      
      - name: Run analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd scripts
          
          # Read the diff content and pass it as an argument
          DIFF_CONTENT=$(cat ../git_diff.txt)
          
          # Run the Ballerina script with the diff content
          bal run analyze_version_change.bal -- "$DIFF_CONTENT"
          
          mv analysis_result.json ../
      
      - name: Display results
        if: always()
        run: |
          if [ -f analysis_result.json ]; then
            echo "Analysis Results:"
            cat analysis_result.json | jq '.'
          fi
      
      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: version-analysis
          path: |
            analysis_result.json
            git_diff.txt
      
      - name: Comment on PR (if triggered by PR)
        if: github.event_name == 'repository_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('analysis_result.json')) {
              console.log('No analysis result found');
              return;
            }
            
            const analysis = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));
            
            let comment = `## ðŸ“Š Version Change Analysis\n\n`;
            comment += `**Recommended Version Bump:** \`${analysis.changeType}\`\n`;
            comment += `**Confidence:** ${analysis.confidence}\n\n`;
            comment += `### Summary\n${analysis.summary}\n\n`;
            
            if (analysis.breakingChanges.length > 0) {
              comment += `### âš ï¸ Breaking Changes\n`;
              analysis.breakingChanges.forEach(change => {
                comment += `- ${change}\n`;
              });
              comment += '\n';
            }
            
            if (analysis.newFeatures.length > 0) {
              comment += `### âœ¨ New Features\n`;
              analysis.newFeatures.forEach(feature => {
                comment += `- ${feature}\n`;
              });
              comment += '\n';
            }
            
            if (analysis.bugFixes.length > 0) {
              comment += `### ðŸ› Improvements\n`;
              analysis.bugFixes.forEach(fix => {
                comment += `- ${fix}\n`;
              });
            }
            
            // Post comment to PR
            // You'll need to pass the PR number via repository_dispatch payload
            const prNumber = context.payload.client_payload?.pr_number;
            
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }