name: Analyze Version Change

on:
  workflow_dispatch:
  repository_dispatch:
    types: [analyze-connector-changes]

jobs:
  analyze:
    name: Analyze connector version changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate focused git diff
        id: diff
        run: |
          echo "Generating diff between master and auto-generate-connector branches..."
          
          # Generate diff focusing on client.bal and types.bal
          # --unified=3 gives 3 lines of context (default, but explicit)
          # --ignore-all-space to reduce noise from formatting
          git diff origin/master...origin/auto-generate-connector \
            --unified=3 \
            -- ballerina/client.bal ballerina/types.bal > git_diff.txt
          
          # Check if diff is not empty
          if [ ! -s git_diff.txt ]; then
            echo "âŒ No changes detected in client.bal or types.bal"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Get diff statistics
          DIFF_SIZE=$(wc -c < git_diff.txt)
          DIFF_LINES=$(wc -l < git_diff.txt)
          
          echo "âœ… Diff generated successfully"
          echo "ðŸ“ Size: $DIFF_SIZE bytes ($DIFF_LINES lines)"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT
          echo "diff_lines=$DIFF_LINES" >> $GITHUB_OUTPUT
          
          # Show first 50 lines as preview
          echo ""
          echo "ðŸ“‹ Diff Preview (first 50 lines):"
          echo "================================"
          head -n 50 git_diff.txt
          echo "================================"
      
      - name: Set up Ballerina
        if: steps.diff.outputs.has_changes == 'true'
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: latest
      
      - name: Run analysis
        if: steps.diff.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd scripts
          
          echo "ðŸ¤– Starting version change analysis..."
          echo "ðŸ“Š Diff statistics:"
          echo "   - Size: ${{ steps.diff.outputs.diff_size }} bytes"
          echo "   - Lines: ${{ steps.diff.outputs.diff_lines }}"
          
          # Run the Ballerina script with the diff file path
          bal run analyze_version_change.bal -- "../git_diff.txt"
          
          # Move result to root for easier access
          mv analysis_result.json ../
      
      - name: Display results
        if: always() && steps.diff.outputs.has_changes == 'true'
        run: |
          if [ -f analysis_result.json ]; then
            echo "ðŸ“Š Analysis Results:"
            echo "==================="
            cat analysis_result.json | jq '.'
            
            # Extract key information
            CHANGE_TYPE=$(jq -r '.changeType' analysis_result.json)
            CONFIDENCE=$(jq -r '.confidence' analysis_result.json)
            
            echo ""
            echo "ðŸ”– Recommended Version Bump: $CHANGE_TYPE"
            echo "âœ… Confidence Score: $CONFIDENCE"
          else
            echo "âš ï¸ No analysis result found"
          fi
      
      - name: Upload analysis results
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: version-analysis
          path: |
            analysis_result.json
            git_diff.txt
          retention-days: 30
      
      - name: Create enhanced PR comment
        if: github.event_name == 'repository_dispatch' && steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('analysis_result.json')) {
              console.log('âŒ No analysis result found');
              return;
            }
            
            const analysis = JSON.parse(fs.readFileSync('analysis_result.json', 'utf8'));
            const diffSize = '${{ steps.diff.outputs.diff_size }}';
            const diffLines = '${{ steps.diff.outputs.diff_lines }}';
            
            // Determine emoji and color based on change type
            const changeTypeEmoji = {
              'MAJOR': 'ðŸ”´',
              'MINOR': 'ðŸŸ¡', 
              'PATCH': 'ðŸŸ¢'
            };
            
            const emoji = changeTypeEmoji[analysis.changeType] || 'âšª';
            
            // Build comment
            let comment = `## ${emoji} Version Change Analysis\n\n`;
            comment += `| Metric | Value |\n`;
            comment += `|--------|-------|\n`;
            comment += `| **Recommended Version Bump** | \`${analysis.changeType}\` |\n`;
            comment += `| **Confidence Score** | ${(analysis.confidence * 100).toFixed(1)}% |\n`;
            comment += `| **Diff Size** | ${diffSize} bytes (${diffLines} lines) |\n`;
            comment += `\n`;
            
            comment += `### ðŸ“ Summary\n${analysis.summary}\n\n`;
            
            if (analysis.breakingChanges && analysis.breakingChanges.length > 0) {
              comment += `### âš ï¸ Breaking Changes\n`;
              analysis.breakingChanges.forEach(change => {
                comment += `- ${change}\n`;
              });
              comment += '\n';
            }
            
            if (analysis.newFeatures && analysis.newFeatures.length > 0) {
              comment += `### âœ¨ New Features\n`;
              analysis.newFeatures.forEach(feature => {
                comment += `- ${feature}\n`;
              });
              comment += '\n';
            }
            
            if (analysis.bugFixes && analysis.bugFixes.length > 0) {
              comment += `### ðŸ› Bug Fixes & Improvements\n`;
              analysis.bugFixes.forEach(fix => {
                comment += `- ${fix}\n`;
              });
              comment += '\n';
            }
            
            // Add interpretation guide
            comment += `---\n`;
            comment += `<details>\n`;
            comment += `<summary>ðŸ“š Version Bump Guidelines</summary>\n\n`;
            comment += `- **MAJOR (ðŸ”´)**: Breaking changes that require users to update their code\n`;
            comment += `- **MINOR (ðŸŸ¡)**: New features added in a backward-compatible manner\n`;
            comment += `- **PATCH (ðŸŸ¢)**: Bug fixes and improvements with no API changes\n`;
            comment += `\n`;
            comment += `*This analysis was performed using AI-powered diff analysis. Please review the changes manually before merging.*\n`;
            comment += `</details>\n`;
            
            // Post comment to PR
            const prNumber = context.payload.client_payload?.pr_number;
            
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log(`âœ… Posted analysis to PR #${prNumber}`);
            } else {
              console.log('âš ï¸ No PR number provided in payload');
              console.log('Comment that would have been posted:');
              console.log(comment);
            }
      
      - name: Set job summary
        if: always() && steps.diff.outputs.has_changes == 'true'
        run: |
          if [ -f analysis_result.json ]; then
            CHANGE_TYPE=$(jq -r '.changeType' analysis_result.json)
            CONFIDENCE=$(jq -r '.confidence' analysis_result.json)
            SUMMARY=$(jq -r '.summary' analysis_result.json)
            
            echo "## ðŸ“Š Version Change Analysis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Version Bump:** \`$CHANGE_TYPE\`" >> $GITHUB_STEP_SUMMARY
            echo "**Confidence:** $CONFIDENCE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi